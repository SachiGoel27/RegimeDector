# Hidden Market Regimes in Correlation Space
## 1. Project Overview & Premise
This project is a quantitative analysis to identify hidden market regimes. The central idea is that market regimes (e.g., "calm," "risk-on," "systemic risk") are not defined by price levels or volatility alone, but rather by the internal correlation structure between assets.

When correlations across all sectors spike simultaneously, it signals a "systemic" regime where all assets move together. This model attempts to detect these regimes and test if they have any predictive power for future volatility or market crashes.

**Research Question**
Can one detect latent market regimes by clustering the time-varying correlation structure of equity sectors? Do transitions into a "high-correlation" regime predict subsequent volatility spikes or market drawdowns?

**Key Findings**
1. Hypothesis Confirmed (in part): High-correlation regimes successfully predict higher future volatility.
2. Hypothesis Contradicted: High-correlation regimes do not predict market crashes or drawdowns. In fact, these "systemic" regimes were found to have the lowest probability of a >5% forward drawdown.
3. Dominant Feature: The most powerful signal identified by the model was the average pairwise correlation (avg_corr). The complex Hidden Markov Model (HMM), after processing all 19 features, primarily isolated this signal.
4. Final Conclusion: The "Systemic / High-Correlation" regime is not a "pre-crash" state but rather a "Volatile Risk-On" state, characterized by high volatility but also strong positive returns.

## 2. Methodology
The analysis was conducted in four main stages: Data Collection, Feature Engineering, Dimensionality Reduction, and Regime Detection.

**Step 1: Data Collection**
- Asset Data: Pulled daily adjusted close prices (2013-Present) for 11 key equity ETFs using yfinance:
  - Broad Market: SPY (S&P 500), IWM (Russell 2000)
  - Sectors: XLK, XLF, XLE, XLY, XLP, XLI, XLV, XLU, XLB
- Macro Data: Pulled daily macroeconomic indicators from FRED using fredapi:
  - VIX, Treasury Yields (DGS10, DGS2), FEDFUNDS, CPI, INDPRO, UNRATE
- Data Cleaning: All price data was converted to daily log returns. Macro data was resampled to a business-day frequency and forward-filled to align with market data.

**Step 2: Feature Engineering**
Instead of feeding the HMM raw prices, I engineered a robust set of 19 features designed to capture the character of the market's correlation structure. These were calculated on a 60-day rolling window:
1. Robust Correlation: Used the LedoitWolf shrinkage model to calculate a stable covariance and correlation matrix for each 60-day window.
2. Correlation Statistics:
  - avg_corr: The mean of all off-diagonal correlations.
  - corr_std: The standard deviation of correlations.
3. Spectral Features (Eigenvalues):
  - top_eig: The first (largest) eigenvalue, representing the principal component of the market (i.e., how much variance is explained by one single factor).
  - eig_gap: The difference between the first and second eigenvalues, measuring the market's "one-dimensionality."
4. Graph Network Features:
  - Treated the correlation matrix as a network graph using networkx.
  - mean_centrality / max_centrality: Eigenvector centrality to find the most "influential" asset.
  - mean_node_strength / max_node_strength: The sum of absolute correlations for each asset.
5. Macro Features:
  - VIX, Term_Spread (10Y-2Y), CPI_YoY, INDPRO_MoM, UNRATE_Change.
Finally, all 19 features were combined and standardized using StandardScaler.

**Step 3: Dimensionality Reduction (PCA)**
The 19 features (e.g., avg_corr, top_eig, VIX) are highly correlated with each other. A Hidden Markov Model (HMM) works best with features that are as independent as possible.

To solve this, I applied Principal Component Analysis (PCA) to transform the 19 correlated features into a smaller set of uncorrelated "Principal Components."
- The analysis showed that 6 components were able to explain 90% of the variance in the original 19 features.
- This 6-component matrix (X_pca) was the final, clean input for the regime detection model.

**Step 4: Regime Detection (HMM)**
A Gaussian Hidden Markov Model (HMM) from hmmlearn was used to find the hidden states.
- Why an HMM? It assumes the market is always in one of several "states" (regimes) and that the features I see (our 6 PCs) are generated by that state. The model's job is to learn the properties of these states and predict which state we are in at any given time.
- Implementation: The model was set to find n_components=3 hidden regimes.
- Output: The model was fitted on X_pca and then used to predict() a regime (0, 1, or 2) for every day in the dataset.

## Results & Analysis
**Finding 1: Interpreting the Regimes**
The HMM successfully identified 3 regimes. By grouping the original, unscaled features by the model's predicted regime, we can understand the "character" of each state.

(Regimes were re-named 0, 1, and 2 based on ascending avg_corr for clarity).
Regime | Original Label | avg_corr | VIX | Term_Spread | Interpretation
---	| --- | --- | --- | --- | ---
Regime 0 | 2 | 0.42 | 13.66 | 0.59 | Calm / Low-Correlation
Regime 1 | 1 | 0.48 | 17.77 | 0.22 | Transition / Mid-Correlation
Regime 2 | 0 | 0.62 | 18.72 | 1.42 | Systemic / High-Correlation

The scatter plot of PC1 vs. PC2 confirms these are distinct clusters, especially Regime 2 (the red cluster), which is clearly separated.

**Finding 2: Predictive Power of Regimes**
This is the "moment of truth." I checked if the regime today has any predictive power over the market's outcome 21 trading days (1 month) into the future.

- Avg. 21-Day Forward Return:
  - Low-Corr (0): +0.32% (Worst performance)
  - Mid-Corr (1): +1.22% (Best performance)
  - High-Corr (2): +1.11% (Strong performance)
  - Insight: This contradicts the hypothesis. The "Systemic" (High-Corr) regime does not precede bad returns. It actually precedes strong positive returns, similar to the "Transition" regime.
- Avg. 21-Day Forward Volatility:
  - Low-Corr (0): 11.5%
  - Mid-Corr (1): 14.2%
  - High-Corr (2): 15.4%
  - Insight: This confirms the hypothesis. There is a clear, ordinal relationship: higher correlation today means higher volatility over the next month.
- Probability of >5% Drawdown:
  - Low-Corr (0): 16.1%
  - Mid-Corr (1): 16.3% (Highest risk)
  - High-Corr (2): 11.9% (Lowest risk)
  - Insight: This is the most surprising finding and strongly contradicts the hypothesis. The "Systemic / High-Correlation" regime, which was assumed to be a "pre-crash" state, actually precedes the lowest probability of a 5% drawdown.

**Finding 3: Statistical Validation (Chi-Squared Test)**
To ensure this surprising drawdown result wasn't just random chance, a Chi-Squared test was performed.
- Null Hypothesis (H0): The regime state and drawdown probability are independent (i.e., the regime has no predictive power).
- Result: The test yielded a p-value of 0.0008.
- Conclusion: Since p < 0.05, I can reject the null hypothesis. The relationship between the regime and the probability of a drawdown is statistically significant.

**Finding 4: Benchmark Comparison (HMM vs. Simple Models)**
The HMM's findings (High-Corr = High Vol, High Return, Low Risk) are robust. But is the HMM necessary? I compared its results to two simpler "benchmark" models:
1. Simple VIX Model: Regimes are defined by splitting VIX into 3 quantiles (Low, Mid, High).
- Result: This model showed the "classic" relationship: High VIX = Low Future Returns and High Drawdown Risk.
2. Simple avg_corr Model: Regimes are defined by splitting avg_corr into 3 quantiles.
- Result: This model produced results nearly identical to the complex HMM: High Corr = High Future Vol and Low Drawdown Risk.

## 4. Final Conclusion
The original hypothesis was only half-right. High correlation does predict high volatility, but it does not predict market crashes.

The key discovery from this analysis is that avg_corr is the dominant feature. The HMM, after processing all 19 features (macro, spectral, and network), essentially isolated avg_corr as the most important signal.

This benchmark comparison does not mean the HMM failed; it means it succeeded in finding the signal that matters. Its data-driven thresholds (0.42, 0.48, 0.62) are more robust than simple 33% quantiles and prove that the market's internal correlation structure is a powerful, and counter-intuitive, predictor of future risk and return.

## 5. How to Run This Project
Dependencies: Install the required libraries:
```
pip install pandas numpy yfinance fredapi scikit-learn matplotlib networkx hmmlearn
```
API Key: You will need a free API key from FRED (Federal Reserve Economic Data). Add your key to the notebook in Cell 4:
```
FRED_API_KEY = "YOUR_API_KEY_HERE"
```
Run: Execute the cells in the RegimeDector.ipynb notebook sequentially.
